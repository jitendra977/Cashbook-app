import React, { useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Stack,
  Typography,
  RadioGroup,
  FormControlLabel,
  Radio,
  Alert,
  CircularProgress,
  Box,
  Divider,
  Chip,
  List,
  ListItem,
  ListItemIcon,
  ListItemText
} from '@mui/material';
import {
  GridOn,
  PictureAsPdf,
  Description,
  Download,
  CheckCircle,
  Info
} from '@mui/icons-material';
import transactionsAPI from '../../api/transactions';

const exportFormats = [
  {
    value: 'excel',
    label: 'Excel Spreadsheet',
    description: 'Professional formatted Excel file with styles',
    icon: <GridOn color="success" />,
    extension: '.xlsx'
  },
  {
    value: 'pdf',
    label: 'PDF Report',
    description: 'Printable PDF document with transaction details',
    icon: <PictureAsPdf color="error" />,
    extension: '.pdf'
  },
  {
    value: 'json',
    label: 'JSON Data',
    description: 'Machine-readable JSON format for data processing',
    icon: <Description color="primary" />,
    extension: '.json'
  }
];

const ExportDialog = ({ open, onClose, filters, dateRange, storeId, cashbookId }) => {
  const [format, setFormat] = useState('excel');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(false);

  const handleExport = async () => {
    setLoading(true);
    setError(null);
    setSuccess(false);

    try {
      const params = {
        ...filters,
        start_date: dateRange?.start_date,
        end_date: dateRange?.end_date,
        store: storeId,
        cashbook: cashbookId
      };

      const timestamp = new Date().toISOString().split('T')[0];
      let response, filename;

      switch (format) {
        case 'excel':
          response = await transactionsAPI.exportTransactionsAsExcel(params);
          filename = `transactions_export_${timestamp}.xlsx`;
          break;
        case 'pdf':
          response = await transactionsAPI.exportTransactionsAsPDF(params);
          filename = `transactions_report_${timestamp}.pdf`;
          break;
        case 'json':
          response = await transactionsAPI.exportTransactionsAsJSON(params);
          filename = `transactions_data_${timestamp}.json`;
          break;
        default:
          throw new Error('Unsupported format');
      }

      downloadFile(response.data, filename, format);
      setSuccess(true);
      setTimeout(() => {
        onClose();
        setSuccess(false);
      }, 2000);

    } catch (err) {
      console.error('Export failed:', err);
      setError(
        err.response?.data?.error || 
        err.message || 
        'Failed to export transactions. Please try again.'
      );
    } finally {
      setLoading(false);
    }
  };

  const downloadFile = (data, filename, format) => {
    const blob = format === 'json' 
      ? new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
      : data;
    
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  };

  const handleClose = () => {
    if (!loading) {
      setError(null);
      setSuccess(false);
      onClose();
    }
  };

  const selectedFormat = exportFormats.find(f => f.value === format);
  const hasActiveFilters = filters && Object.keys(filters).length > 0 || dateRange;

  return (
    <Dialog open={open} onClose={handleClose} maxWidth="sm" fullWidth>
      <DialogTitle>
        <Stack direction="row" alignItems="center" spacing={1}>
          <Download />
          <Typography variant="h6">Export Transactions</Typography>
        </Stack>
      </DialogTitle>

      <DialogContent>
        <Stack spacing={3}>
          <Alert severity="info" icon={<Info />}>
            <Typography variant="body2">
              Export will include all transactions matching your current filters and date range.
            </Typography>
          </Alert>

          {hasActiveFilters && (
            <Box>
              <Typography variant="subtitle2" gutterBottom color="text.secondary">
                Active Filters:
              </Typography>
              <Stack direction="row" spacing={1} flexWrap="wrap" gap={1}>
                {dateRange?.start_date && (
                  <Chip size="small" label={`From: ${dateRange.start_date}`} variant="outlined" />
                )}
                {dateRange?.end_date && (
                  <Chip size="small" label={`To: ${dateRange.end_date}`} variant="outlined" />
                )}
                {storeId && (
                  <Chip size="small" label={`Store: ${storeId}`} variant="outlined" />
                )}
                {cashbookId && (
                  <Chip size="small" label={`Cashbook: ${cashbookId}`} variant="outlined" />
                )}
              </Stack>
            </Box>
          )}

          <Divider />

          <Box>
            <Typography variant="subtitle2" gutterBottom fontWeight="bold">
              Select Export Format
            </Typography>
            <RadioGroup value={format} onChange={(e) => setFormat(e.target.value)}>
              <List>
                {exportFormats.map((fmt) => (
                  <ListItem
                    key={fmt.value}
                    sx={{
                      border: 1,
                      borderColor: format === fmt.value ? 'primary.main' : 'divider',
                      borderRadius: 1,
                      mb: 1,
                      bgcolor: format === fmt.value ? 'action.selected' : 'background.paper',
                      '&:hover': { bgcolor: 'action.hover', cursor: 'pointer' }
                    }}
                    onClick={() => setFormat(fmt.value)}
                  >
                    <FormControlLabel
                      value={fmt.value}
                      control={<Radio />}
                      label=""
                      sx={{ m: 0, mr: 2 }}
                    />
                    <ListItemIcon sx={{ minWidth: 40 }}>{fmt.icon}</ListItemIcon>
                    <ListItemText
                      primary={<Typography variant="subtitle1" fontWeight="medium">{fmt.label}</Typography>}
                      secondary={fmt.description}
                    />
                    <Chip label={fmt.extension} size="small" variant="outlined" />
                  </ListItem>
                ))}
              </List>
            </RadioGroup>
          </Box>

          {error && <Alert severity="error" onClose={() => setError(null)}>{error}</Alert>}
          {success && (
            <Alert severity="success" icon={<CheckCircle />}>
              Export successful! File is downloading...
            </Alert>
          )}
        </Stack>
      </DialogContent>

      <DialogActions sx={{ px: 3, pb: 2 }}>
        <Button onClick={handleClose} disabled={loading} color="inherit">
          Cancel
        </Button>
        <Button
          onClick={handleExport}
          variant="contained"
          startIcon={loading ? <CircularProgress size={20} /> : <Download />}
          disabled={loading}
        >
          {loading ? 'Exporting...' : `Export as ${selectedFormat?.label}`}
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default ExportDialog;




















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































